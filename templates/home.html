{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="main-page">
    <div class="boards-header">
        <h1>üìÇ–ú–æ–∏ –¥–æ—Å–∫–∏</h1>
        <button class="create-board-btn" id="create-board-btn" style="display:none;"><b>+ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é
                –¥–æ—Å–∫—É</b></button>
    </div>
    <div id="boards-grid" class="boards-grid"></div>
</div>

<!-- –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Å–∫–∏ -->
<div id="delete-modal" class="modal" style="display:none;">
    <div class="modal-content" style="position:relative;">
        <button id="close-delete-modal" class="modal-close-btn">&times;</button>
        <div class="modal-title">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –¥–æ—Å–∫—É?</div>
        <div class="modal-actions">
            <button id="confirm-delete-btn" class="modal-btn delete">–î–∞</button>
            <button id="cancel-delete-btn" class="modal-btn">–ù–µ—Ç</button>
        </div>
    </div>
</div>

<!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å–∫–∏ -->
<div id="create-modal" class="modal" style="display:none;">
    <div class="modal-content" style="position:relative;">
        <button id="close-create-modal" class="modal-close-btn">&times;</button>
        <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –¥–æ—Å–∫—É</div>
        <form class="create-board-form" autocomplete="off" onsubmit="return false;">
            <label class="modal-label">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å–∫–∏<span style="color:#e45d5d;">*</span></label>
            <input id="board-title-input" type="text" class="modal-input" maxlength="120" required>
            <label class="modal-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <textarea id="board-desc-input" class="modal-input" rows="2" maxlength="300"></textarea>
            <div class="modal-actions modal-actions-bottom">
                <button type="button" id="cancel-create-btn" class="modal-btn">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" id="submit-create-btn" class="modal-btn create">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ò–∑–º–µ–Ω–∏—Ç—å –¥–æ—Å–∫—É" -->
<div id="edit-modal" class="modal" style="display:none;">
    <div class="modal-content" style="position:relative;">
        <button id="close-edit-modal" class="modal-close-btn">&times;</button>
        <div class="modal-title">–ò–∑–º–µ–Ω–∏—Ç—å –¥–æ—Å–∫—É</div>
        <form class="edit-board-form" autocomplete="off" onsubmit="return false;">
            <label class="modal-label">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ—Å–∫–∏<span style="color:#e45d5d;">*</span></label>
            <input id="edit-board-title-input" type="text" class="modal-input" maxlength="120" required>
            <label class="modal-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea id="edit-board-desc-input" class="modal-input" rows="2" maxlength="300"></textarea>
            <div class="modal-actions modal-actions-bottom">
                <button type="button" id="cancel-edit-btn" class="modal-btn">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" id="submit-edit-btn" class="modal-btn create">–ò–∑–º–µ–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extrascripts %}
<script>
    function formatDate(datetime) {
        const d = new Date(datetime);
        return d.toLocaleDateString('ru-RU') + ' ' + d.toLocaleTimeString('ru-RU').slice(0, 5);
    }

    let boardToDelete = null;

    window.deleteBoard = function (boardId) {
        boardToDelete = boardId;
        document.getElementById("delete-modal").style.display = "flex";
    }

    document.addEventListener("DOMContentLoaded", function () {
        const grid = document.getElementById("boards-grid");
        const createBtn = document.getElementById("create-board-btn");
        const token = localStorage.getItem("authToken");

        function renderBoards(boards) {
            grid.innerHTML = "";
            if (boards.length) {
                boards.forEach(board => {
                    const card = document.createElement("div");
                    card.className = "board-card";
                    card.dataset.boardId = board.id;
                    card.innerHTML = `
                    <div class="board-card-header">
                        <span class="board-title">${board.title}</span>
                    </div>
                    <div class="board-card-description">${board.description ? board.description : ""}</div>
                    <div class="mini-divider"></div>
                    <div class="board-card-footer">
                        <span class="board-date">–°–æ–∑–¥–∞–Ω–∞: ${formatDate(board.created_at)}</span>
                        <div class="board-actions">
                            <button class="board-action-btn"onclick="event.stopPropagation(); renameBoard('${board.id}','${board.title.replace(/'/g, "\\'")}',\`${(board.description || "").replace(/`/g, "\\`")}\`)">‚úèÔ∏è</button>
                            <button class="board-action-btn delete" onclick="event.stopPropagation(); deleteBoard('${board.id}')">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                    card.onclick = (e) => {
                        if (!e.target.classList.contains('board-action-btn')) {
                            window.location.href = `/board/${board.id}/`;
                        }
                    };
                    grid.appendChild(card);
                });
            } else {
                grid.innerHTML = '<div class="no-boards-message">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –¥–æ—Å–æ–∫.</div>';
            }
        }

        function renderGuest() {
            grid.innerHTML = '<div class="no-boards-message">–í–æ–π–¥–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å–æ–∫.</div>';
            createBtn.style.display = "none";
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Å–∫–∏
        document.getElementById("confirm-delete-btn").onclick = function () {
            if (!boardToDelete) return;
            fetch(`/api/boards/${boardToDelete}/`, {
                method: "DELETE",
                headers: { "Authorization": "Token " + token }
            }).then(() => {
                // –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–æ—Å–∫–∏ –∏–∑ DOM:
                const el = document.querySelector(`[data-board-id='${boardToDelete}']`);
                if (el) el.remove();
                document.getElementById("delete-modal").style.display = "none";
                boardToDelete = null;
                // –ï—Å–ª–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ—Å–æ–∫, –ø–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:
                if (!document.querySelector('.board-card')) {
                    grid.innerHTML = '<div class="no-boards-message">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –¥–æ—Å–æ–∫.</div>';
                }
            });
        };

        document.getElementById("cancel-delete-btn").onclick = function () {
            document.getElementById("delete-modal").style.display = "none";
            boardToDelete = null;
        };

        // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ—Å–∫–∏
        let boardToEditId = null;

        window.renameBoard = function (boardId, oldTitle, oldDesc = "") {
            boardToEditId = boardId;
            document.getElementById("edit-board-title-input").value = oldTitle || "";
            document.getElementById("edit-board-desc-input").value = oldDesc || "";
            document.getElementById("edit-modal").style.display = "flex";
            document.getElementById("edit-board-title-input").focus();
        };


        if (token) {
            fetch("/api/boards/", {
                headers: { "Authorization": "Token " + token }
            })
                .then(res => res.json())
                .then(data => {
                    createBtn.style.display = "inline-block";
                    renderBoards(data);
                })
                .catch(() => renderGuest());
        } else {
            renderGuest();
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è
        createBtn.onclick = function () {
            document.getElementById("create-modal").style.display = "flex";
            document.getElementById("board-title-input").value = "";
            document.getElementById("board-desc-input").value = "";
            document.getElementById("board-title-input").focus();
        };

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞ (–ø–æ X –∏–ª–∏ "–û—Ç–º–µ–Ω–∞")
        function closeCreateModal() {
            document.getElementById("create-modal").style.display = "none";
        }
        document.getElementById("close-create-modal").onclick = closeCreateModal;
        document.getElementById("cancel-create-btn").onclick = closeCreateModal;

        // –ó–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ –•
        document.getElementById("close-delete-modal").onclick = function () {
            document.getElementById("delete-modal").style.display = "none";
            boardToDelete = null;
        };

        // –°–∞–±–º–∏—Ç —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
        document.querySelector(".create-board-form").onsubmit = function () {
            const boardTitle = document.getElementById("board-title-input").value.trim();
            const boardDesc = document.getElementById("board-desc-input").value.trim();
            if (!boardTitle) {
                document.getElementById("board-title-input").focus();
                return false;
            }
            fetch("/api/boards/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Token " + token
                },
                body: JSON.stringify({ title: boardTitle, description: boardDesc })
            })
                .then(res => res.json())
                .then(board => {
                    closeCreateModal();
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π board –≤ DOM:
                    renderBoards([board, ...Array.from(document.querySelectorAll('.board-card')).map(cardEl => ({
                        id: cardEl.dataset.boardId,
                        title: cardEl.querySelector('.board-title').textContent,
                        description: cardEl.querySelector('.board-card-description').textContent,
                        created_at: cardEl.querySelector('.board-date')?.textContent?.replace('–°–æ–∑–¥–∞–Ω–∞: ', '') || ''
                    }))]);
                });
            return false;
        };

        // –ó–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–æ X –∏–ª–∏ "–û—Ç–º–µ–Ω–∞"
        function closeEditModal() {
            document.getElementById("edit-modal").style.display = "none";
            boardToEditId = null;
        }
        document.getElementById("close-edit-modal").onclick = closeEditModal;
        document.getElementById("cancel-edit-btn").onclick = closeEditModal;

        // –°–∞–±–º–∏—Ç —Ñ–æ—Ä–º—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è
        document.querySelector(".edit-board-form").onsubmit = function () {
            const newTitle = document.getElementById("edit-board-title-input").value.trim();
            const newDesc = document.getElementById("edit-board-desc-input").value.trim();
            if (!newTitle) {
                document.getElementById("edit-board-title-input").focus();
                return false;
            }
            fetch(`/api/boards/${boardToEditId}/`, {
                method: "PATCH",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Token " + token
                },
                body: JSON.stringify({ title: newTitle, description: newDesc })
            })
                .then(res => res.json())
                .then(updatedBoard => {
                    closeEditModal();
                    // –û–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É –¥–æ—Å–∫–∏ –≤ DOM:
                    const card = document.querySelector(`[data-board-id='${updatedBoard.id}']`);
                    if (card) {
                        card.querySelector('.board-title').textContent = updatedBoard.title;
                        card.querySelector('.board-card-description').textContent = updatedBoard.description || "";
                    }
                });
            return false;
        };
    });
</script>
{% endblock %}