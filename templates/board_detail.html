{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="board-detail">
    <div class="board-header">
        <h2 id="board-title" class="board-title-centered"></h2>
        <div class="add-list-row">
            <input type="text" id="new-list-title" class="add-list-input" placeholder="Введите название списка" />
            <button id="add-list-btn" class="add-list-btn"><b>+ добавить список</b></button>
        </div>
    </div>
    <div id="lists-container" class="lists-container"></div>
</div>
<div id="modal-overlay" class="modal-overlay" style="display:none">
    <div id="modal-window" class="modal-window"></div>
</div>
{% endblock %}

{% block extrascripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("authToken");
        const boardId = window.location.pathname.split("/").filter(Boolean)[1]; // /board/<id>/
        const boardTitleEl = document.getElementById("board-title");
        const listsCont = document.getElementById("lists-container");
        const addListBtn = document.getElementById("add-list-btn");

        function renderBoard(board) {
            boardTitleEl.textContent = board.title;
            addListBtn.style.display = "inline-block";
            listsCont.innerHTML = "";
            board.lists
                .slice()
                .sort((a, b) => a.id - b.id) // или .sort((a, b) => a.position - b.position)
                .forEach(list => {
                    const listCol = document.createElement("div");
                    listCol.className = "list-column";
                    listCol.dataset.listId = list.id;
                    if (list.color === "red") listCol.style.background = "#ffe0e0";
                    else if (list.color === "yellow") listCol.style.background = "#fffacc";
                    else if (list.color === "green") listCol.style.background = "#e6fbd9";

                    // Лист header
                    const header = document.createElement("div");
                    header.className = "list-header";
                    header.innerHTML = `
                        <span class="list-title">${list.title}</span>
                        <button class="list-menu-btn" data-list-id="${list.id}">
                            <span class="list-menu-icon">
                                <span></span><span></span><span></span>
                            </span>
                        </button>
                    `;
                    const menu = document.createElement("div");
                    menu.className = "list-menu-dropdown";
                    menu.innerHTML = `
                        <div class="list-menu-item" data-action="edit" data-list-id="${list.id}">Изменить название</div>
                        <div class="list-menu-item" data-action="color" data-list-id="${list.id}">Изменить цвет</div>
                        <div class="list-menu-item delete" data-action="delete" data-list-id="${list.id}">Удалить список</div>
                    `;
                    menu.style.display = "none";
                    header.appendChild(menu);
                    // Обработчик на троеточие:
                    header.querySelector('.list-menu-btn').onclick = (e) => {
                        e.stopPropagation();
                        menu.style.display = menu.style.display === "block" ? "none" : "block";
                    };
                    listCol.appendChild(header);

                    // Карточки
                    const cardsCont = document.createElement("div");
                    cardsCont.className = "cards-container";
                    cardsCont.dataset.listId = list.id;

                    // ... заполняем карточки ...
                    list.cards.forEach(card => {
                        const cardEl = document.createElement("div");
                        cardEl.className = "card";
                        cardEl.draggable = true;
                        cardEl.dataset.cardId = card.id;
                        cardEl.innerHTML = `
                        <div class="card-title-row">
                            <div class="card-title">${card.title}</div>
                            <button class="card-remove-btn" data-card-id="${card.id}" title="Удалить карточку">
                                <span class="card-remove-x">&#10005;</span>
                            </button>
                        </div>
                        <div class="card-desc">${card.description}</div>
                    `;
                        cardsCont.appendChild(cardEl);
                    });
                    cardsCont.addEventListener("click", function (e) {
                        if (e.target.closest(".card-remove-btn")) {
                            const cardId = e.target.closest(".card-remove-btn").dataset.cardId;
                            fetch(`/api/cards/${cardId}/`, {
                                method: "DELETE",
                                headers: { "Authorization": "Token " + token }
                            }).then(() => {
                                // Удаляем карточку из DOM без перезагрузки:
                                const cardEl = cardsCont.querySelector(`[data-card-id='${cardId}']`);
                                if (cardEl) cardEl.remove();
                            });
                        }
                    });

                    // -- вот тут добавь поля ввода --
                    const addCardRow = document.createElement("div");
                    addCardRow.className = "add-card-row";
                    addCardRow.innerHTML = `
                    <input type="text" class="add-card-title-input" placeholder="Название задачи..." />
                    <textarea class="add-card-desc-input" placeholder="Описание задачи (необязательно)..." rows="2"></textarea>
                `;
                    cardsCont.appendChild(addCardRow);

                    const addCardBtn = document.createElement("button");
                    addCardBtn.className = "add-card-btn";
                    addCardBtn.textContent = "Добавить карточку";
                    addCardBtn.dataset.listId = list.id;
                    cardsCont.appendChild(addCardBtn);

                    addCardBtn.onclick = function () {
                        const cardTitle = addCardRow.querySelector(".add-card-title-input").value.trim();
                        const cardDesc = addCardRow.querySelector(".add-card-desc-input").value.trim();
                        if (!cardTitle) return;
                        fetch("/api/cards/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "Authorization": "Token " + token
                            },
                            body: JSON.stringify({ title: cardTitle, description: cardDesc, list: list.id })
                        })
                            .then(res => res.json())
                            .then(card => {
                                // Создаём карточку в DOM как обычно:
                                const cardEl = document.createElement("div");
                                cardEl.className = "card";
                                cardEl.draggable = true;
                                cardEl.dataset.cardId = card.id;
                                cardEl.innerHTML = `
                                <div class="card-title-row">
                                    <div class="card-title">${card.title}</div>
                                    <button class="card-remove-btn" data-card-id="${card.id}" title="Удалить карточку">
                                    <span class="card-remove-x">&#10005;</span>
                                    </button>
                                </div>
                                <div class="card-desc">${card.description}</div>
                            `;
                                // Вставляем перед полями ввода и кнопкой:
                                cardsCont.insertBefore(cardEl, addCardRow);

                                // Очищаем поля:
                                addCardRow.querySelector(".add-card-title-input").value = "";
                                addCardRow.querySelector(".add-card-desc-input").value = "";
                            });
                    }

                    listCol.appendChild(cardsCont);
                    listsCont.appendChild(listCol);
                });
        }
        // Получить board + отрисовать
        if (token && boardId) {
            fetch(`/api/boards/${boardId}/`, {
                headers: { "Authorization": "Token " + token }
            })
                .then(res => res.json())
                .then(board => renderBoard(board));
        }

        // Добавить лист
        addListBtn.onclick = function () {
            const listTitleInput = document.getElementById('new-list-title');
            const listTitle = listTitleInput.value.trim();
            if (!listTitle) return;
            fetch("/api/lists/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Token " + token
                },
                body: JSON.stringify({ title: listTitle, board: boardId })
            })
                .then(() => {
                    // Очищаем поле:
                    listTitleInput.value = "";
                    fetch(`/api/boards/${boardId}/`, {
                        headers: { "Authorization": "Token " + token }
                    })
                        .then(res => res.json())
                        .then(board => renderBoard(board));
                });
        }

        // Event delegation для карточек/листов
        listsCont.addEventListener('click', function (e) {
            if (e.target.classList.contains('list-menu-item')) {
                const action = e.target.dataset.action;
                const listId = e.target.dataset.listId;
                if (action === "edit") showEditModal(listId, e.target);
                if (action === "color") showColorModal(listId, e.target);
                if (action === "delete") showDeleteModal(listId, e.target);
            }
        });

        // Drag-drop карточек между списками
        listsCont.addEventListener("dragstart", function (e) {
            if (e.target.classList.contains("card")) {
                e.dataTransfer.setData("cardId", e.target.dataset.cardId);
                e.dataTransfer.setData("fromListId", e.target.closest(".cards-container").dataset.listId);
            }
        });

        listsCont.addEventListener("dragover", function (e) {
            if (e.target.classList.contains("cards-container")) e.preventDefault();
        });

        listsCont.addEventListener("drop", function (e) {
            if (e.target.classList.contains("cards-container")) {
                e.preventDefault();
                const cardId = e.dataTransfer.getData("cardId");
                const toListId = e.target.dataset.listId;
                fetch(`/api/cards/${cardId}/move/`, {
                    method: "PATCH",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Token " + token
                    },
                    body: JSON.stringify({ list: toListId })
                }).then(() => window.location.reload());
            }
        });
    });
    document.body.addEventListener('click', function (e) {
        // скрыть все меню если клик вне .list-menu-btn/.list-menu-dropdown
        document.querySelectorAll('.list-menu-dropdown').forEach(m => m.style.display = "none");
    });

    function showEditModal(listId) {
        const listTitle = document.querySelector(`[data-list-id='${listId}'] .list-title`).textContent;
        showModal(`
        <div class="modal-title">Изменить название списка</div>
        <input type="text" id="modal-edit-title" value="${listTitle}" class="modal-input" />
        <div class="modal-actions">
        <button onclick="closeModal()" class="modal-btn">Отмена</button>
        <button onclick="saveListTitle('${listId}')" class="modal-btn primary">Сохранить</button>
        </div>
    `);
    }
    function saveListTitle(listId) {
        const newTitle = document.getElementById('modal-edit-title').value.trim();
        if (newTitle) {
            fetch(`/api/lists/${listId}/`, {
                method: "PATCH",
                headers: { "Content-Type": "application/json", "Authorization": "Token " + localStorage.getItem("authToken") },
                body: JSON.stringify({ title: newTitle })
            })
                .then(res => res.json())
                .then(updatedList => {
                    // Обновить название в DOM без перезагрузки:
                    document.querySelector(`[data-list-id="${listId}"] .list-title`).textContent = updatedList.title;
                    closeModal();
                });
        }
    }
    function showColorModal(listId) {
        showModal(`
        <div class="modal-title">Выберите цвет для списка</div>
        <div class="modal-color-row">
        <div class="color-square red" onclick="setListColor('${listId}', 'red')"></div>
        <div class="color-square yellow" onclick="setListColor('${listId}', 'yellow')"></div>
        <div class="color-square green" onclick="setListColor('${listId}', 'green')"></div>
        </div>
        <button onclick="closeModal()" class="modal-btn">Отмена</button>
    `);
    }
    function setListColor(listId, color) {
        fetch(`/api/lists/${listId}/`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json", "Authorization": "Token " + localStorage.getItem("authToken") },
            body: JSON.stringify({ color: color })
        })
            .then(res => res.json())
            .then(updatedList => {
                // Меняем цвет только у нужного списка без reload:
                const listCol = document.querySelector(`[data-list-id='${listId}']`);
                if (listCol) {
                    if (updatedList.color === "red") listCol.style.background = "#ffe0e0";
                    else if (updatedList.color === "yellow") listCol.style.background = "#fffacc";
                    else if (updatedList.color === "green") listCol.style.background = "#e6fbd9";
                    else listCol.style.background = "";
                }
                closeModal();
            });
    }
    function showDeleteModal(listId) {
        showModal(`
        <div class="modal-title">Вы уверены что хотите удалить список?</div>
        <div class="modal-actions">
        <button onclick="closeModal()" class="modal-btn">Нет</button>
        <button onclick="deleteList('${listId}')" class="modal-btn danger">Да</button>
        </div>
    `);
    }
    function deleteList(listId) {
        fetch(`/api/lists/${listId}/`, {
            method: "DELETE",
            headers: { "Authorization": "Token " + localStorage.getItem("authToken") }
        }).then(() => {
            // Удалить столбец только в DOM:
            const listEl = document.querySelector(`[data-list-id='${listId}']`);
            if (listEl) listEl.remove();
            closeModal();
        });
    }
    function showModal(html) {
        document.getElementById('modal-window').innerHTML = html;
        document.getElementById('modal-overlay').style.display = "flex";
    }
    function closeModal() {
        document.getElementById('modal-overlay').style.display = "none";
    }
</script>
{% endblock %}